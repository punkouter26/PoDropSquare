@using Po.PoDropSquare.Blazor.Models
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http

@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="HandleBackdropClick">
        <div class="score-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="trophy-icon">üèÜ</span>
                    <span>TOP 10 SCORE!</span>
                </h2>
            </div>

            <div class="modal-content">
                <div class="score-display">
                    <div class="final-time">
                        <span class="time-label">YOUR TIME</span>
                        <span class="time-value">@SurvivalTime.ToString("0.00") s</span>
                    </div>
                    
                    <div class="arcade-message">
                        ENTER YOUR INITIALS
                    </div>
                </div>

                @if (!IsSubmitted)
                {
                    <div class="submission-form arcade-style">
                        <div class="initials-input-group">
                            <input 
                                id="playerInitials"
                                type="text" 
                                @bind="playerInitials" 
                                @bind:event="oninput"
                                @onkeypress="HandleKeyPress"
                                placeholder="___"
                                maxlength="3"
                                disabled="@IsSubmitting"
                                class="arcade-initials-input @(HasValidationError ? "error" : "")"
                                autocomplete="off"
                                spellcheck="false" />
                        </div>

                        @if (HasValidationError)
                        {
                            <div class="validation-error arcade-error">@ValidationMessage</div>
                        }

                        <div class="form-actions arcade-buttons">
                            <button 
                                class="arcade-btn submit-btn" 
                                @onclick="SubmitScore" 
                                disabled="@(IsSubmitting || playerInitials.Length < 1)">
                                @if (IsSubmitting)
                                {
                                    <span class="spinner"></span>
                                    <span>SAVING...</span>
                                }
                                else
                                {
                                    <span>SAVE SCORE</span>
                                }
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="submission-result">
                        @if (SubmissionSuccess)
                        {
                            <div class="success-message arcade-message">
                                <span class="success-icon">‚úÖ</span>
                                <h3>SCORE SAVED!</h3>
                                <p>@SubmissionMessage</p>
                                
                                @if (Rank.HasValue)
                                {
                                    <div class="rank-display arcade-rank">
                                        <span class="rank-text">RANK: </span>
                                        <span class="rank-value">#@Rank</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="error-message arcade-message">
                                <span class="error-icon">‚ùå</span>
                                <h3>ERROR</h3>
                                <p>@SubmissionMessage</p>
                                
                                <button class="arcade-btn retry-btn" @onclick="RetrySubmission">
                                    TRY AGAIN
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="modal-footer">
                @if (IsSubmitted && SubmissionSuccess)
                {
                    <button class="arcade-btn primary-btn" @onclick="ViewLeaderboard">
                        VIEW LEADERBOARD
                    </button>
                    <button class="arcade-btn secondary-btn" @onclick="PlayAgain">
                        PLAY AGAIN
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public int Score { get; set; }
    [Parameter] public double SurvivalTime { get; set; }
    [Parameter] public TimeSpan? GameDuration { get; set; }
    [Parameter] public bool IsNewHighScore { get; set; } = false;
    [Parameter] public int? Rank { get; set; }
    [Parameter] public bool AllowClose { get; set; } = true;
    [Parameter] public bool AllowSkip { get; set; } = true;
    [Parameter] public string? SessionId { get; set; }
    [Parameter] public EventCallback<PlayerScore> OnScoreSubmitted { get; set; }
    [Parameter] public EventCallback OnModalClosed { get; set; }
    [Parameter] public EventCallback OnPlayAgain { get; set; }
    [Parameter] public EventCallback OnViewLeaderboard { get; set; }

    private string playerInitials = string.Empty;
    private bool IsSubmitting = false;
    private bool IsSubmitted = false;
    private bool SubmissionSuccess = false;
    private string SubmissionMessage = string.Empty;
    private bool HasValidationError = false;
    private string ValidationMessage = string.Empty;

    protected override void OnParametersSet()
    {
        // Auto-uppercase initials
        if (!string.IsNullOrEmpty(playerInitials))
        {
            playerInitials = playerInitials.ToUpper();
        }

        // Reset state when modal becomes visible
        if (IsVisible && !IsSubmitted)
        {
            ResetForm();
        }
    }

    private void ResetForm()
    {
        playerInitials = string.Empty;
        IsSubmitting = false;
        IsSubmitted = false;
        SubmissionSuccess = false;
        SubmissionMessage = string.Empty;
        HasValidationError = false;
        ValidationMessage = string.Empty;
    }

    private bool ValidateInput()
    {
        HasValidationError = false;
        ValidationMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(playerInitials))
        {
            HasValidationError = true;
            ValidationMessage = "ENTER YOUR INITIALS";
            return false;
        }

        // Must be 1-3 characters
        if (playerInitials.Length < 1 || playerInitials.Length > 3)
        {
            HasValidationError = true;
            ValidationMessage = "1-3 CHARACTERS ONLY";
            return false;
        }

        // Only allow A-Z and 0-9
        if (!playerInitials.All(c => char.IsLetterOrDigit(c)))
        {
            HasValidationError = true;
            ValidationMessage = "LETTERS & NUMBERS ONLY";
            return false;
        }

        return true;
    }

    private async Task SubmitScore()
    {
        if (!ValidateInput() || IsSubmitting)
            return;

        try
        {
            IsSubmitting = true;
            StateHasChanged();

            var submission = new
            {
                playerInitials = playerInitials.ToUpper(),
                survivalTime = SurvivalTime,
                sessionSignature = GenerateSessionSignature(),
                clientTimestamp = DateTime.UtcNow.ToString("O")
            };

            Console.WriteLine($"Submitting score: {playerInitials} - {SurvivalTime}s");

            var response = await Http.PostAsJsonAsync("/api/scores", submission);
            
            IsSubmitted = true;
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ScoreSubmissionResult>();
                
                if (result?.Success == true)
                {
                    SubmissionSuccess = true;
                    SubmissionMessage = $"TIME: {SurvivalTime:0.00}s";
                    
                    if (result.ScoreDetails?.Rank > 0)
                    {
                        Rank = result.ScoreDetails.Rank;
                    }
                }
                else
                {
                    SubmissionSuccess = false;
                    SubmissionMessage = result?.Message ?? "SUBMISSION FAILED";
                }
            }
            else
            {
                SubmissionSuccess = false;
                SubmissionMessage = response.StatusCode switch
                {
                    System.Net.HttpStatusCode.BadRequest => "INVALID DATA",
                    System.Net.HttpStatusCode.TooManyRequests => "TOO MANY REQUESTS",
                    System.Net.HttpStatusCode.InternalServerError => "SERVER ERROR",
                    _ => $"ERROR ({response.StatusCode})"
                };
            }
        }
        catch (HttpRequestException)
        {
            IsSubmitted = true;
            SubmissionSuccess = false;
            SubmissionMessage = "NETWORK ERROR";
        }
        catch (Exception ex)
        {
            IsSubmitted = true;
            SubmissionSuccess = false;
            SubmissionMessage = "UNEXPECTED ERROR";
            Console.WriteLine($"Score submission error: {ex.Message}");
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private string GenerateSessionSignature()
    {
        // Simple signature based on time and random value
        var data = $"{SurvivalTime}-{DateTime.UtcNow.Ticks}-{Guid.NewGuid()}";
        using var sha256 = System.Security.Cryptography.SHA256.Create();
        var hash = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(data));
        return Convert.ToHexString(hash);
    }

    private void RetrySubmission()
    {
        IsSubmitted = false;
        SubmissionSuccess = false;
        StateHasChanged();
    }

    private async Task CloseModal()
    {
        IsVisible = false;
        await OnModalClosed.InvokeAsync();
    }

    private async Task PlayAgain()
    {
        await OnPlayAgain.InvokeAsync();
        await CloseModal();
    }

    private async Task ViewLeaderboard()
    {
        await OnViewLeaderboard.InvokeAsync();
        await CloseModal();
    }

    private void HandleBackdropClick()
    {
        // Arcade modals don't close on backdrop click
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && playerInitials.Length >= 1)
        {
            await SubmitScore();
        }
    }

    // Simplified DTO classes
    private class ScoreSubmissionResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public ScoreDetails? ScoreDetails { get; set; }
    }

    private class ScoreDetails
    {
        public int Rank { get; set; }
    }
}


<style>
    /* Arcade-style modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
    }

    .score-modal {
        background: #000;
        border: 4px solid #00ff00;
        box-shadow: 0 0 20px #00ff00, inset 0 0 20px rgba(0, 255, 0, 0.1);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: arcadeGlow 2s ease-in-out infinite;
        font-family: 'Courier New', monospace;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #00ff00;
        background: rgba(0, 255, 0, 0.05);
    }

    .modal-title {
        margin: 0;
        color: #00ff00;
        font-size: 1.8rem;
        font-weight: bold;
        text-align: center;
        text-shadow: 0 0 10px #00ff00;
        letter-spacing: 3px;
    }

    .trophy-icon {
        font-size: 2rem;
        animation: bounce 1s ease-in-out infinite;
    }

    .modal-content {
        padding: 2rem 1.5rem;
    }

    .score-display {
        text-align: center;
        margin-bottom: 2rem;
    }

    .final-time {
        margin-bottom: 1.5rem;
    }

    .time-label {
        display: block;
        color: #00ff00;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        letter-spacing: 2px;
    }

    .time-value {
        display: block;
        color: #ffff00;
        font-size: 4rem;
        font-weight: bold;
        text-shadow: 0 0 20px #ffff00;
        animation: timePulse 1.5s ease-in-out infinite;
        font-family: 'Courier New', monospace;
    }

    .arcade-message {
        color: #00ff00;
        font-size: 1.3rem;
        letter-spacing: 2px;
        text-align: center;
        margin: 1.5rem 0;
        text-shadow: 0 0 5px #00ff00;
    }

    .submission-form.arcade-style {
        background: none;
        padding: 0;
    }

    .initials-input-group {
        display: flex;
        justify-content: center;
        margin: 2rem 0;
    }

    .arcade-initials-input {
        width: 200px;
        padding: 1rem;
        border: 3px solid #00ff00;
        background: #000;
        color: #ffff00;
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        font-family: 'Courier New', monospace;
        letter-spacing: 10px;
        text-transform: uppercase;
        box-shadow: 0 0 10px #00ff00, inset 0 0 10px rgba(0, 255, 0, 0.1);
        animation: inputBlink 1s step-end infinite;
    }

    .arcade-initials-input:focus {
        outline: none;
        border-color: #ffff00;
        box-shadow: 0 0 15px #ffff00, inset 0 0 15px rgba(255, 255, 0, 0.1);
    }

    .arcade-initials-input.error {
        border-color: #ff0000;
        box-shadow: 0 0 15px #ff0000;
    }

    .arcade-initials-input::placeholder {
        color: rgba(0, 255, 0, 0.3);
    }

    .arcade-initials-input:disabled {
        opacity: 0.5;
    }

    .validation-error.arcade-error {
        color: #ff0000;
        font-size: 1rem;
        text-align: center;
        margin-top: 1rem;
        text-shadow: 0 0 5px #ff0000;
        letter-spacing: 2px;
    }

    .arcade-buttons {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }

    .arcade-btn {
        padding: 1rem 2rem;
        border: 3px solid #00ff00;
        background: #000;
        color: #00ff00;
        font-size: 1.2rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-shadow: 0 0 5px #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }

    .arcade-btn:hover:not(:disabled) {
        background: #00ff00;
        color: #000;
        text-shadow: none;
        box-shadow: 0 0 20px #00ff00;
        transform: scale(1.05);
    }

    .arcade-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .arcade-btn.primary-btn {
        border-color: #ffff00;
        color: #ffff00;
        text-shadow: 0 0 5px #ffff00;
        box-shadow: 0 0 10px #ffff00;
    }

    .arcade-btn.primary-btn:hover:not(:disabled) {
        background: #ffff00;
        color: #000;
    }

    .arcade-btn.secondary-btn {
        border-color: #ff00ff;
        color: #ff00ff;
        text-shadow: 0 0 5px #ff00ff;
        box-shadow: 0 0 10px #ff00ff;
    }

    .arcade-btn.secondary-btn:hover:not(:disabled) {
        background: #ff00ff;
        color: #000;
    }

    .arcade-btn.retry-btn {
        border-color: #ff0000;
        color: #ff0000;
        text-shadow: 0 0 5px #ff0000;
        box-shadow: 0 0 10px #ff0000;
    }

    .submission-result {
        text-align: center;
    }

    .success-message,
    .error-message {
        padding: 1.5rem;
    }

    .success-message h3,
    .error-message h3 {
        color: #00ff00;
        font-size: 1.5rem;
        letter-spacing: 3px;
        margin: 1rem 0;
        text-shadow: 0 0 10px #00ff00;
    }

    .error-message h3 {
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000;
    }

    .success-icon,
    .error-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 1rem;
    }

    .success-message p,
    .error-message p {
        color: #00ff00;
        font-size: 1.1rem;
        letter-spacing: 1px;
    }

    .arcade-rank {
        margin-top: 1.5rem;
        padding: 1rem;
        border: 2px solid #ffff00;
        background: rgba(255, 255, 0, 0.05);
    }

    .rank-text {
        color: #00ff00;
        font-size: 1.2rem;
        letter-spacing: 2px;
    }

    .rank-value {
        color: #ffff00;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 0 0 10px #ffff00;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 2px solid #00ff00;
        display: flex;
        gap: 1rem;
        justify-content: center;
        background: rgba(0, 255, 0, 0.05);
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid transparent;
        border-top: 3px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 0.5rem;
    }

    /* Animations */
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes arcadeGlow {
        0%, 100% { box-shadow: 0 0 20px #00ff00, inset 0 0 20px rgba(0, 255, 0, 0.1); }
        50% { box-shadow: 0 0 30px #00ff00, inset 0 0 30px rgba(0, 255, 0, 0.2); }
    }

    @@keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    @@keyframes timePulse {
        0%, 100% { transform: scale(1); text-shadow: 0 0 20px #ffff00; }
        50% { transform: scale(1.05); text-shadow: 0 0 30px #ffff00; }
    }

    @@keyframes inputBlink {
        0%, 49% { border-color: #00ff00; }
        50%, 100% { border-color: #ffff00; }
    }

    @@keyframes spin {
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @@media (max-width: 600px) {
        .time-value {
            font-size: 3rem;
        }

        .arcade-initials-input {
            width: 150px;
            font-size: 2.5rem;
            letter-spacing: 5px;
        }

        .modal-footer {
            flex-direction: column;
        }
    }
</style>
